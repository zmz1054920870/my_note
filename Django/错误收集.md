# ä¸€ã€**æŠ¥é”™ï¼šAttributeError: 'str' object has no attribute 'decode'**

## 1ã€ç‰ˆæœ¬ä¿¡æ¯

https://blog.csdn.net/qq_36274515/article/details/89043481

python ç‰ˆæœ¬ : 3.6.6

Django ç‰ˆæœ¬: 2.2.1

è¿™æ˜¯ä¸€ä¸ªçº¿ä¸Šçš„é—®é¢˜ï¼Œ åœ¨åç»­çš„Djangoç‰ˆæœ¬ä¸­å·²ç»ä¿®å¤ã€‚é‚£æˆ‘ä»¬æ¥æ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿ

æ‰¾åˆ°djangoçš„ `operations.py` æ–‡ä»¶

è·¯å¾„ï¼š site-packages/django/db/backends/mysql/operations.py

æƒ³è±¡ï¼šæ‰§è¡Œpython manage.py migrateçš„æ—¶å€™æŠ¥é”™

## 2ã€è°ƒè¯•æ€è·¯

é¦–å…ˆæˆ‘ä»¬æ˜¯é€šè¿‡ `python manage.py makemigrations`å‘½ä»¤è¿›è¡Œæ•°æ®è¿ç§»æ—¶æŠ¥é”™çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»å…¥å£å‡½æ•°å…¥æ‰‹ã€‚æ‰“å¼€manage.pyæ–‡ä»¶

![image-20211205170659599](image-20211205170659599.png)

æˆ‘ä»¬çœ‹åˆ°ä»–æ˜¯é€šè¿‡sys.argvæ¥æ”¶æˆ‘ä»¬å‘½ä»¤å‚æ•°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è‡ªå·±æ„é€ ä¼ å…¥çš„å‚æ•°ï¼Œç„¶åæ‰“æ–­ç‚¹è¿›è¡Œè°ƒè¯•

sys.argv == ['manage.py', 'makemigrations']

å°†['manage.py', 'makemigrations']æ›¿æ¢åˆ°sys.argv

![image-20211205170858126](image-20211205170858126.png)



ç„¶åæˆ‘ä»¬å†çœ‹çœ‹æŠ¥é”™ä¿¡æ¯ï¼Œçœ‹æœ€åä¸€æ¡ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯åœ¨å“ªä¸€è¡Œä»£ç æŠ¥é”™çš„ï¼Ÿ

![image-20211205170947076](image-20211205170947076.png)

å‘ç°æ˜¯`D:\Django\mysite\env\lib\site-packages\django\db\backends\mysql\operations.py"`çš„146è¡Œã€‚

é‚£ä¹ˆæˆ‘ä»¬æ‰¾åˆ°è¿™ä¸ªè¡Œä»£ç ï¼Œæ‰“ä¸Šä¸¤ä¸ªç«¯ç‚¹ã€‚æˆ‘ä»¬åœ¨å›åˆ°manage.pyæ–‡ä»¶ä¸­

![image-20211205171046308](image-20211205171046308.png)



ç‚¹å‡»debugæŒ‰é’®

![image-20211205171244360](image-20211205171244360.png)



æˆ‘ä»¬çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯

![image-20211205171402563](image-20211205171402563.png)

ç„¶åä¸‹é¢

```python
query = query.decode(errors='replace') , å­—ç¬¦ä¸²ç±»å‹æ˜¯æ²¡æœ‰decodeæ–¹æ³•çš„ï¼Œæ‰€ä»¥æŠ¥é”™äº†
```



æ€ä¹ˆæ”¹å‘¢ï¼Ÿ

- ç¬¬ä¸€ç§æ–¹æ³•ï¼Œé‚£å°±æ˜¯æ³¨é‡Šæ‰



ç¬¬äºŒç§æ–¹æ³•ï¼š

åœ¨operations.pyä¸­å¯¼å…¥å¦‚ä¸‹åŒ…

```
from django.utils.encoding import force_text
```

ç„¶åå°†`last_executed_query`æ”¹æˆå¦‚ä¸‹

```python
    def last_executed_query(self, cursor, sql, params):
        # With MySQLdb, cursor objects have an (undocumented) "_executed"
        # attribute where the exact query sent to the database is saved.
        # See MySQLdb/cursors.py in the source distribution.
        # query = getattr(cursor, '_executed', None)
        # if query is not None:
        #     query = query.decode(errors='replace')
        # return query
        force_text(getattr(cursor, '_executed', None), errors='replace')
```

è¿™ä¸ªæ”¹å‘æ˜¯å®˜æ–¹åç»­ä¿®å¤çš„ç‰ˆæœ¬





# äºŒã€æŠ¥é”™ï¼šdjango.db.utils.OperationalError: (1170, "BLOB/TEXT column 'content' used in key specification without a key length")

é”™è¯¯æ¨¡å‹å¦‚ä¸‹ï¼š

![image-20211205173751758](image-20211205173751758.png)



æŠ¥é”™åŸå› ï¼šmysqlåˆ›å»ºå”¯ä¸€é”®å€¼çš„æ—¶å€™ä¸èƒ½ä½¿ç”¨textè¦ä½¿ç”¨varchar

æ‰€ä»¥æˆ‘ä»¬è¦æŠŠ unique è¿™ä¸ªç©æ„ç»™ä»–åˆ é™¤äº†ï¼Œå°±å¯ä»¥äº†





# ä¸‰ã€æŠ¥é”™ï¼šnews.News.category: (fields.E300) Field defines a relation with model 'Category', which is either not installed, or is abstract.

news.News.category: (models.E006) The field 'category' clashes with the field 'category' from model 'news.basemodel'.



åœ¨ä½¿ç”¨æ¨¡å‹æŠ½è±¡æ–¹å¼çš„æ—¶å€™æŠ¥é”™

```python
from django.db import models

# Create your models here.
from django.db import models
from abc import ABCMeta
# Create your models here.


class BaseModel(models.Model):
    is_deleted = models.BooleanField(verbose_name='æ˜¯å¦åˆ é™¤', default=False)
    create_time = models.DateTimeField(verbose_name='åˆ›å»ºæ—¶é—´', auto_now_add=True)
    update_time = models.DateTimeField(verbose_name='æ›´æ–°æ—¶é—´', auto_now=True)
    
    class Meta:
        db_table = 'news_base'
        # abstract = True			ğŸ”ºğŸ”ºğŸ”ºğŸ”ºğŸ”ºå¿…é¡»åŠ è¿™ä¸ªç©æ„ï¼Œä¸ç„¶æŠ¥é”™ï¼Œq


class Category(BaseModel):

    name = models.CharField(verbose_name='åˆ†ç±»åå­—', max_length=5, null=False, unique=True)
    position = models.IntegerField(verbose_name='åˆ†ç±»æ’åº', null=False)
    category_extend = models.CharField(verbose_name='æ‹“å±•å­—æ®µ', default='', max_length=255)

    def __str__(self):
        return self.name

    class Meta:
        db_table = 'category'


class News(BaseModel):

    title = models.CharField(verbose_name='åˆ†ç±»åå­—', max_length=255, null=False, unique=True)
    content = models.TextField(verbose_name='å†…å®¹', null=False, max_length=4000)
    is_top = models.BooleanField(verbose_name='æ˜¯å¦ç½®é¡¶', default=False)
    src = models.URLField(verbose_name='å°é¢', null=False)
    is_original = models.BooleanField(verbose_name='æ˜¯å¦åŸåˆ›')
    news_extend = models.CharField(verbose_name='æ‹“å±•å­—æ®µ', default='', max_length=255)
    watch_number = models.IntegerField(verbose_name='æµé‡é‡', default=0)
    category = models.ForeignKey(to=Category, on_delete=models.CASCADE)

    def __str__(self):
        return self.title

    class Meta:
        db_table = 'news'
```

è¿™æ˜¯æˆ‘æ•…æ„çš„ï¼Œè§£å†³åŠæ³•å°±æ˜¯ï¼Œåªè¦åœ¨class Metaä¸­æ·»åŠ abstract = Trueå°±è¡Œäº†



# å››ã€Djangoçš„ORMæ¨¡å‹å»é‡é—®é¢˜

#### **é—®é¢˜è§£å†³é“¾æ¥ï¼š**

- https://www.cnblogs.com/cpl9412290130/p/11777633.html

- https://www.jianshu.com/p/78d5cdf2904a

#### ç°è±¡ï¼šæˆ‘æƒ³æŸ¥å·®è¯„æ•°é‡å¤§äº1çš„ï¼Œå»é‡å·²è¢«åˆ é™¤çš„å­—æ®µ

![image-20211211172429798](image-20211211172429798.png)

```bash
num = Article.objects.filter(cnum__gt=10).distinct('id_delete')
```

#### æŠ¥é”™ï¼š

```bash
django.db.utils.NotSupportedError: DISTINCT ON fields is not supported by this database backend
# distinct on å­—æ®µä¸æ”¯æŒè¿™ä¸ªæ•°æ®åº“åç«¯
```

æŸ¥é˜…ç½‘ä¸Šèµ„æ–™ï¼šå®˜ç½‘æåˆ°äº†ä¸Šé¢è¿™ç§é”™è¯¯çš„å†™æ³•ï¼Œåœ¨mysqlä¸­æ˜¯ä¸æ”¯æŒçš„ï¼Œæ”¯æŒpostgresqlï¼Œä¹Ÿå°±æ˜¯distinct()é‡Œé¢ä¸èƒ½æŒ‡å®šå­—æ®µã€‚

å…ˆçœ‹ä¸€ä¸‹distinctçš„æºç ï¼š

```python
1 def distinct(self, *field_names):
2     """
3     Return a new QuerySet instance that will select only distinct results.
	  è¿”å›ä¸€ä¸ªæ–°çš„ QuerySet å®ä¾‹ï¼Œå®ƒå°†åªé€‰æ‹©ä¸é‡å¤çš„ç»“æœã€‚
4     """
5     assert self.query.can_filter(), \
6         "Cannot create distinct fields once a slice has been taken."
7     obj = self._chain()
8     obj.query.add_distinct_fields(*field_names)
9     return obj
```

ä½¿ç”¨distinctä¼šè¿”å›ä¸€ä¸ªæ–°çš„æŸ¥è¯¢é›†åˆï¼Œä¼šæ˜¾ç¤ºä¸é‡å¤çš„ç»“æœï¼Œè¾¾åˆ°å»é‡çš„ç›®çš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ¥å—çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªfield_nameså‚æ•°ï¼Œä¹Ÿå°±æ˜¯å„å­—æ®µåç§°

#### é”™è¯¯è§£å†³ï¼š

ä½†æ˜¯mysqlä¸èƒ½ä¼ å‚æ•°åˆ°distincté‡Œé¢å•Šï¼Œä¸èƒ½è¿™æ ·ï¼Œé‚£æˆ‘ä»¬å¯ä»¥æŠŠæ•°æ®å†™åˆ°valuesæˆ–è€…values_listé‡Œé¢å»ä¸å°±å¥½äº†ã€‚

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºdistinctæœ¬æ¥å°±æ˜¯é’ˆå¯¹æŸ¥è¯¢é›†æ¥æ“ä½œçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥ä½¿ç”¨æŸ¥è¯¢é›†ï¼Œç»™è¿™ä¸ªæŸ¥è¯¢é›†å»é‡ï¼Œç„¶åæ–°çš„æŸ¥è¯¢é›†ä¸ä¹…OKäº†ã€‚ã€‚

valuesï¼ˆï¼‰æ–¹æ³•å°±æ˜¯ç”ŸæˆæŸ¥è¯¢é›†

valueså¯ä»¥æ¥æ”¶å¤šä¸ªå­—æ®µå

```
num = Article.objects.values('id_delete').distinct()
```

![image-20211211165351993](image-20211211165351993.png)



**å…¶ä»–é—®é¢˜ï¼šæ•°æ®ä¸å¯¹å•Šï¼ŒæŒ‰ç…§è¿™æ ·æ¥å»é‡ï¼Œåº”è¯¥åªæœ‰ä¸€æ¡æ•°æ®æ‰å¯¹å•Š**

**é—®é¢˜åŸå› ï¼š**

distinct()å…·æœ‰å»é‡åŠŸèƒ½æ˜¯æ²¡æœ‰å¿…è¦æ€€ç–‘çš„ï¼Œdistinct()å‡½æ•°æœ‰ä¸€ä¸ªéšè—ç‰¹æ€§ï¼Œå½“ä½¿ç”¨distinct()å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœä¸ä½¿ç”¨order_by()å‡½æ•°åšè·Ÿéšï¼Œé‚£ä¹ˆè¯¥å‡½æ•°ä¼šè‡ªåŠ¨æŠŠå½“å‰è¡¨ä¸­çš„é»˜è®¤æ’åºå­—æ®µä½œä¸ºDISTINCTçš„ä¸€ä¸ªåˆ—ï¼Œæ‰€ä»¥ä¸Šè¿°é—®é¢˜å‡ºç°çš„åŸå› æ˜¯å› ä¸ºæˆ‘æ²¡æœ‰ä½¿ç”¨order_by('id_delete')æ¥å±è”½distinct()çš„é‚£ä¸ªç‰¹æ€§ï¼Œä»è€Œå¾—å‡ºçš„distinctç»“æœå¹¶ä¸æ˜¯ä»…ä»…ä»¥id_deleteä¸€ä¸ªåˆ—ä½œä¸ºå‚æ•°çš„ï¼Œè€Œæ˜¯ä»¥id+id_deleteä¸¤åˆ—çš„å€¼ä½œä¸ºdistinctå‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°idåˆ—é‡Œé¢çš„å€¼å…¨éƒ¨éƒ½æ˜¯å”¯ä¸€å€¼ï¼Œæ‰€ä»¥å¾—å‡ºæ¥çš„ç»“æœå¿…ç„¶æ˜¯ä»¥idåˆ—çš„å€¼ä¸ºæ ‡å‡†çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯çš„åŸå› ï¼Œè€Œå¦‚æœæƒ³è¦å®ç°ä¸Šè¿°ä¾‹å­éœ€æ±‚ï¼Œæ­£ç¡®çš„ä»£ç å†™æ³•æ˜¯

```bash
num = Article.objects.values('id_delete').filter(cnum__gt=1).distinct().order_by('id_delete')
```

![image-20211211173218295](image-20211211173218295.png)

è¿™é‡Œorder_by('id')æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºä»–é»˜è®¤å°±æ˜¯è¿™ä¸ªç©æ„

å½“valuesä¸­æœ‰å¤šä¸ªå‚æ•°çš„æ—¶å€™ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªè¿‡æ¥order_byå°±å¯ä»¥äº†





# äº”ã€åŸå§‹SQLæŸ¥è¯¢æŠ¥é”™ï¼ˆåŸå§‹æŸ¥è¯¢å¿…é¡»åŒ…æ‹¬ä¸»é”®ï¼‰

django.db.models.query_utils.InvalidQuery: Raw query must include the primary key

ç°è±¡ï¼šæˆ‘æ‰§è¡ŒåŸå§‹SQLçš„æ—¶å€™ï¼Œåœ¨navicateä¸­å¯ä»¥æ­£ç¡®æŸ¥è¯¢ï¼Œä½†æ˜¯åœ¨pythonä»£ç ä¸­å°±ä¸è¡Œæç¤ºdjango.db.models.query_utils.InvalidQuery: Raw query must include the primary key

```
article = Article.objects.raw('select user.name, article.title from user join article on user.id = article.users_id')
print(article.query)
print('3333333333333333333333333333333', article, type(article))
for item in article:
print(item.name, item.title, item.id,  type(item))

```

è§£å†³åŠæ³•ï¼š

åŠ ä¸Šä¸»é”®æŸ¥è¯¢å°±è¡Œäº†

```python
    article = Article.objects.raw('select user.name, article.title, article.id from user join article on user.id = article.users_id')

```

å¼•å…¥çš„æ–°é—®é¢˜ï¼š

- è¿™ä¸ªarticle.idä¸èƒ½åƒsqlåŸç”Ÿè¯­å¥ä¸€æ ·ï¼Œå–åˆ«åï¼Œå¦‚æœå–äº†åˆ«åä»¥åï¼Œè¿˜æ˜¯ä¼šæŠ¥å¿…é¡»æŒ‡å®šä¸»é”®

- å½“æˆ‘ä»¬åœ¨è”è¡¨æŸ¥è¯¢çš„æ—¶å€™ï¼ŒæŒ‡å®šä¸€ä¸ªè¡¨çš„ä¸»é”®å³å¯

- å¦‚æœæŠŠä¸¤å¼ è¡¨çš„idéƒ½æŒ‡å®šäº†çš„è¯ï¼Œè°åœ¨å‰é¢å–è°çš„å€¼ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç»™å…¶ä¸­ä¸€ä¸ªä¸»é”®çš„idæŒ‡å®šåˆ«å

```python
article = Article.objects.raw('select user.name, article.title, article.id, user.id as user_id from user join article on user.id = article.users_id')


article = Article.objects.raw('select `user`.`name`, `article`.`title`, article.id, user.id as user_id from user join article on user.id = article.users_id')
```

- å®Œå…¨æŒ‰ç…§SQLä¸€æ ·ï¼Œå¯¹ä¸€äº›å…³é”®å­—æ®µåŠ ä¸ŠåŒ``ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œæ··åˆä½¿ç”¨ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚ä¸ºä»€ä¹ˆè¦åŠ ï¼Œæ˜¯å› ä¸ºå¯ä»¥æ’é™¤æ‰sqlçš„æœ¬èº«çš„å ç”¨å­—ç¬¦ï¼ŒåŠ ä¸Šä»¥åå°±ç›¸å½“äºpythonçš„r'' ä¸€æ ·ï¼Œå˜æˆåŸå§‹å­—ç¬¦





# å…­ã€æ•°æ®åº“è¿ç§»æ—¶å€™æ— æ³•ç”Ÿäº§æ•°æ®åº“è¡¨

  No migrations to apply.

æƒ³è±¡ï¼šæˆ‘åˆ é™¤äº† djangoé¡¹ç›®ä¸­appç›®å½•ä¸‹migrationsæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶æƒ…å†µäº†_pyç¼“å­˜æ–‡ä»¶ã€‚æ‰§è¡Œè¿ç§»çš„æ—¶å€™ï¼Œä¸€ç›´ç»™æˆ‘æç¤ºNo migrations to apply

è§£å†³åŠæ³•ï¼š

é€šè¿‡navicateè¿›å…¥æˆ‘ä»¬çš„æ•°æ®åº“

æ‰¾åˆ°ä¸‹é¢è¿™å¼ è¡¨

![image-20211212184338343](image-20211212184338343.png)

æ‰§è¡Œæƒ…å†µè¡¨çš„å‘½ä»¤

![image-20211212184359910](image-20211212184359910.png)
